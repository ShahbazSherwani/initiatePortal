-- Migration 012: Create vulnerability scanning tables
-- Description: Tracks vulnerability scans and discovered security issues

-- Table for scan history
CREATE TABLE IF NOT EXISTS vulnerability_scan_history (
  id SERIAL PRIMARY KEY,
  total_vulnerabilities INTEGER DEFAULT 0,
  critical_count INTEGER DEFAULT 0,
  high_count INTEGER DEFAULT 0,
  moderate_count INTEGER DEFAULT 0,
  low_count INTEGER DEFAULT 0,
  fixable_count INTEGER DEFAULT 0,
  scan_date TIMESTAMP DEFAULT NOW(),
  scan_duration INTEGER, -- in milliseconds
  status VARCHAR(50) DEFAULT 'completed'
);

-- Table for individual vulnerabilities
CREATE TABLE IF NOT EXISTS vulnerability_scans (
  id SERIAL PRIMARY KEY,
  scan_id INTEGER NOT NULL,
  package_name VARCHAR(255) NOT NULL,
  severity VARCHAR(20) NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  cve VARCHAR(50),
  current_version VARCHAR(100),
  fix_available BOOLEAN DEFAULT FALSE,
  recommended_version VARCHAR(100),
  source VARCHAR(50) DEFAULT 'npm-audit',
  resolved BOOLEAN DEFAULT FALSE,
  resolved_at TIMESTAMP,
  resolved_by VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (scan_id) REFERENCES vulnerability_scan_history(id) ON DELETE CASCADE
);

-- Indexes for efficient querying
CREATE INDEX IF NOT EXISTS idx_vuln_scan_history_date ON vulnerability_scan_history(scan_date DESC);
CREATE INDEX IF NOT EXISTS idx_vuln_scans_scan_id ON vulnerability_scans(scan_id);
CREATE INDEX IF NOT EXISTS idx_vuln_scans_severity ON vulnerability_scans(severity);
CREATE INDEX IF NOT EXISTS idx_vuln_scans_package ON vulnerability_scans(package_name);
CREATE INDEX IF NOT EXISTS idx_vuln_scans_resolved ON vulnerability_scans(resolved);
CREATE INDEX IF NOT EXISTS idx_vuln_scans_cve ON vulnerability_scans(cve) WHERE cve IS NOT NULL;

-- Comments
COMMENT ON TABLE vulnerability_scan_history IS 'History of vulnerability scans with summary statistics';
COMMENT ON TABLE vulnerability_scans IS 'Individual vulnerabilities discovered during scans';
COMMENT ON COLUMN vulnerability_scans.severity IS 'Vulnerability severity: critical, high, moderate, low';
COMMENT ON COLUMN vulnerability_scans.fix_available IS 'Whether an automatic fix is available';
COMMENT ON COLUMN vulnerability_scans.resolved IS 'Whether the vulnerability has been fixed';

-- Rollback instructions
-- DROP TABLE IF EXISTS vulnerability_scans;
-- DROP TABLE IF EXISTS vulnerability_scan_history;
